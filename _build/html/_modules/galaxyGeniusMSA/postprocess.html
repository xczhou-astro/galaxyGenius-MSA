

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>galaxyGeniusMSA.postprocess &mdash; galaxyGenius-MSA 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
      <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            galaxyGenius-MSA
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">galaxyGenius-MSA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">galaxyGeniusMSA.postprocess</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for galaxyGeniusMSA.postprocess</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.constants</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">const</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.cosmology</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cosmology</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">skimage.transform</span><span class="w"> </span><span class="kn">import</span> <span class="n">rescale</span><span class="p">,</span> <span class="n">rotate</span><span class="p">,</span> <span class="n">downscale_local_mean</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">patches</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.cm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">colors</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib_scalebar.scalebar</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScaleBar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib_scalebar.dimension</span><span class="w"> </span><span class="kn">import</span> <span class="n">_Dimension</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numba</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba.typed</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">types</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rocket_fft</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_config</span><span class="p">,</span> <span class="n">galaxygenius_data_dir</span><span class="p">,</span> <span class="n">setup_logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_wave_for_emission_line</span><span class="p">,</span> <span class="n">read_json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.properties</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ParsecDimension</span><span class="p">(</span><span class="n">_Dimension</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;pc&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_units</span><span class="p">(</span><span class="s1">&#39;kpc&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    
<span class="k">class</span><span class="w"> </span><span class="nc">AngleDimension</span><span class="p">(</span><span class="n">_Dimension</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;${^{\prime\prime}}$&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_units</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;${^{\prime}}$&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>


<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_trapezoid_numba</span><span class="p">(</span><span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_integrate_counts_numba</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">wave_bins</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                                <span class="n">aperture</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">pixel_scale</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                                <span class="n">throughput_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">count_constants</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
    
    <span class="n">wavelength</span> <span class="o">=</span> <span class="n">throughput_dict</span><span class="p">[</span><span class="s1">&#39;wavelengths&#39;</span><span class="p">]</span>
    <span class="n">throughput</span> <span class="o">=</span> <span class="n">throughput_dict</span><span class="p">[</span><span class="s1">&#39;throughput&#39;</span><span class="p">]</span>
    
    <span class="n">values</span> <span class="o">=</span> <span class="n">values</span> <span class="o">/</span> <span class="n">wave_bins</span><span class="o">**</span><span class="mi">2</span>
    
    <span class="n">thr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">wave_bins</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">throughput</span><span class="p">)</span>

    <span class="n">const_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">aperture</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pixel_scale</span><span class="o">**</span><span class="mi">2</span>
    
    <span class="n">count_rate</span> <span class="o">=</span> <span class="n">_trapezoid_numba</span><span class="p">(</span><span class="n">wave_bins</span> <span class="o">*</span> <span class="n">values</span> <span class="o">*</span> <span class="n">thr</span><span class="p">,</span> <span class="n">wave_bins</span><span class="p">)</span>
    <span class="n">count_rate</span> <span class="o">=</span> <span class="n">count_rate</span> <span class="o">*</span> <span class="n">count_constants</span> <span class="o">*</span> <span class="n">const_factor</span>
    
    <span class="k">return</span> <span class="n">count_rate</span>


<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_count_rate_numba</span><span class="p">(</span><span class="n">wavelength</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">waves_at_pixel</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                        <span class="n">throughput_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">count_constants</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">numSpecWaveBins</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> 
                        <span class="n">aperture</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">pixel_scale</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    
    <span class="n">count_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">waves_at_pixel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numba</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">waves_at_pixel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">wave_begin</span> <span class="o">=</span> <span class="n">waves_at_pixel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">wave_end</span> <span class="o">=</span> <span class="n">waves_at_pixel</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    
        <span class="n">wave_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">wave_begin</span><span class="p">,</span> <span class="n">wave_end</span><span class="p">,</span> <span class="n">numSpecWaveBins</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="n">flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">wave_bins</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">)</span>
        <span class="n">count_rate</span> <span class="o">=</span> <span class="n">_integrate_counts_numba</span><span class="p">(</span>
            <span class="n">flux</span><span class="p">,</span> <span class="n">wave_bins</span><span class="p">,</span> <span class="n">aperture</span><span class="p">,</span> <span class="n">pixel_scale</span><span class="p">,</span> <span class="n">throughput_dict</span><span class="p">,</span> <span class="n">count_constants</span>
        <span class="p">)</span>
        <span class="n">count_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">count_rate</span>
    
    <span class="k">return</span> <span class="n">count_rates</span>

<span class="nd">@staticmethod</span>
<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_numba_convolve_fft_static</span><span class="p">(</span><span class="n">cube</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">psf</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">n_wave</span><span class="p">,</span> <span class="n">h_img</span><span class="p">,</span> <span class="n">w_img</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">h_ker</span><span class="p">,</span> <span class="n">w_ker</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">shape</span>
    
    <span class="n">pad_h</span> <span class="o">=</span> <span class="n">h_img</span> <span class="o">+</span> <span class="n">h_ker</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">pad_w</span> <span class="o">=</span> <span class="n">w_img</span> <span class="o">+</span> <span class="n">w_ker</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="n">start_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_ker</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">start_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_ker</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    
    <span class="c1"># Pre-allocate output to avoid memory fragmentation</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_wave</span><span class="p">,</span> <span class="n">h_img</span><span class="p">,</span> <span class="n">w_img</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cube</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numba</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="n">n_wave</span><span class="p">):</span>
        <span class="c1"># Perform 2D convolution for the single slice</span>
        <span class="n">img_slice</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ker_slice</span> <span class="o">=</span> <span class="n">psf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="n">sl_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft2</span><span class="p">(</span><span class="n">img_slice</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="n">pad_h</span><span class="p">,</span> <span class="n">pad_w</span><span class="p">))</span>
        <span class="n">kf_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft2</span><span class="p">(</span><span class="n">ker_slice</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="n">pad_h</span><span class="p">,</span> <span class="n">pad_w</span><span class="p">))</span>
        
        <span class="n">res_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft2</span><span class="p">(</span><span class="n">sl_freq</span> <span class="o">*</span> <span class="n">kf_freq</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="n">pad_h</span><span class="p">,</span> <span class="n">pad_w</span><span class="p">))</span>
        
        <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_full</span><span class="p">[</span><span class="n">start_y</span> <span class="p">:</span> <span class="n">start_y</span> <span class="o">+</span> <span class="n">h_img</span><span class="p">,</span> <span class="n">start_x</span> <span class="p">:</span> <span class="n">start_x</span> <span class="o">+</span> <span class="n">w_img</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">output</span>

<span class="nd">@staticmethod</span>
<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span>
<span class="s2">&quot;float32[:, :](float32[:, :, :], float32[:], float32[:])&quot;</span><span class="p">,</span> 
<span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">integrate_bandpass</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tran</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">wave</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="c1"># not-used</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numba</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">tran</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">wave</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">y2</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">tran</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">wave</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">wave</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">wave</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">integral</span> <span class="o">+=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">+</span> <span class="n">y2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">integral</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="nd">@staticmethod</span>
<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_add_noise_numba</span><span class="p">(</span>
    <span class="n">counts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">bkg_counts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">dark_counts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">readout</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">n_exposure</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    
    <span class="n">ideal_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">mean_noise_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numba</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">)):</span>
        <span class="n">mean_noise_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkg_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">dark_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
    <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">+</span> <span class="n">mean_noise_counts</span>
    
    <span class="c1"># Poisson noise</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numba</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">)):</span>
        <span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="c1"># Read noise for each exposure</span>
    <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_exposure</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numba</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">)):</span>
            <span class="n">read_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="n">readout</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">read_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">read_noise</span><span class="p">)</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">read_noise</span>
    
    <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">-</span> <span class="n">mean_noise_counts</span>
    
    <span class="c1"># Calculate noise counts</span>
    <span class="n">noise_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numba</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">)):</span>
        <span class="n">noise_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">ideal_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">bkg_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">dark_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_exposure</span> <span class="o">*</span> <span class="n">readout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">counts</span><span class="p">,</span> <span class="n">noise_counts</span>

<span class="nd">@staticmethod</span>
<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_rebin_fluxes_and_noise_numba</span><span class="p">(</span>
    <span class="n">wavelengths_in</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">fluxes_in</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">noise_in_squared</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">sed_in</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">wavelengths_out</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    
    <span class="c1"># wavelengths_out is wave edges</span>
    <span class="n">fluxes_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wavelengths_out</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fluxes_in</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">noise_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wavelengths_out</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">noise_in_squared</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">sed_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wavelengths_out</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">sed_in</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numba</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wavelengths_out</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">w_start</span> <span class="o">=</span> <span class="n">wavelengths_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">w_end</span> <span class="o">=</span> <span class="n">wavelengths_out</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">idx_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">wavelengths_in</span><span class="p">,</span> <span class="n">w_start</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">idx_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">wavelengths_in</span><span class="p">,</span> <span class="n">w_end</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        
        <span class="n">idx_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">idx_start</span><span class="p">)</span>
        <span class="n">idx_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fluxes_in</span><span class="p">),</span> <span class="n">idx_end</span><span class="p">)</span>
        
        <span class="n">widths_in</span> <span class="o">=</span> <span class="n">w_end</span> <span class="o">-</span> <span class="n">w_start</span>
        
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx_start</span><span class="p">,</span> <span class="n">idx_end</span><span class="p">):</span>
            
            <span class="n">p_start</span> <span class="o">=</span> <span class="n">wavelengths_in</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">p_end</span> <span class="o">=</span> <span class="n">wavelengths_in</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            
            <span class="n">overlap_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">w_start</span><span class="p">,</span> <span class="n">p_start</span><span class="p">)</span>
            <span class="n">overlap_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">w_end</span><span class="p">,</span> <span class="n">p_end</span><span class="p">)</span>
            <span class="n">overlap_width</span> <span class="o">=</span> <span class="n">overlap_end</span> <span class="o">-</span> <span class="n">overlap_start</span>
            
            <span class="k">if</span> <span class="n">overlap_width</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.0</span><span class="p">):</span>
                <span class="n">frac</span> <span class="o">=</span> <span class="n">overlap_width</span> <span class="o">/</span> <span class="n">widths_in</span>
                <span class="n">fluxes_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fluxes_in</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">frac</span>
                <span class="n">noise_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">noise_in_squared</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">frac</span>
                <span class="n">sed_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sed_in</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">frac</span>
                
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numba</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">noise_out</span><span class="p">)):</span>
        <span class="n">noise_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">noise_out</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">fluxes_out</span><span class="p">,</span> <span class="n">noise_out</span><span class="p">,</span> <span class="n">sed_out</span>

<span class="nd">@staticmethod</span>
<span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_overlap_counts_numba</span><span class="p">(</span><span class="n">counts_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                            <span class="n">noise_counts_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                            <span class="n">sed_counts_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                            <span class="n">n_pixels_slitlet_parallel</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> \
                                <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>

    
    <span class="c1"># counts_array: 40, 18, num_wave</span>
    <span class="n">num_pixels_on_detector</span> <span class="o">=</span> <span class="n">counts_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">size_on_detector</span> <span class="o">=</span> <span class="n">num_pixels_on_detector</span> <span class="o">+</span> <span class="n">n_pixels_slitlet_parallel</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="c1"># overlapped_counts_array: 40, 9, num_wave</span>
    <span class="n">overlapped_shape</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">counts_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">counts_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">n_pixels_slitlet_parallel</span><span class="p">,</span>
        <span class="n">counts_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="n">overlapped_counts_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
        <span class="n">overlapped_shape</span>
    <span class="p">))</span>
    
    <span class="n">overlapped_noise_counts_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
        <span class="n">overlapped_shape</span>
    <span class="p">))</span>
    
    <span class="n">overlapped_sed_counts_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
        <span class="n">overlapped_shape</span>
    <span class="p">))</span>
    
    <span class="n">offset</span> <span class="o">=</span> <span class="n">n_pixels_slitlet_parallel</span> <span class="o">//</span> <span class="mi">2</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numba</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="n">overlapped_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">overlapped_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            
            <span class="n">line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size_on_detector</span><span class="p">))</span>
            
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pixels_slitlet_parallel</span><span class="p">):</span>
                <span class="n">line</span><span class="p">[</span><span class="n">k</span><span class="p">:</span> <span class="n">k</span> <span class="o">+</span> <span class="n">num_pixels_on_detector</span><span class="p">]</span> <span class="o">+=</span> \
                    <span class="n">counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">*</span> <span class="n">n_pixels_slitlet_parallel</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span>
                    
            <span class="n">extracted_counts</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">offset</span><span class="p">:]</span>
            <span class="n">overlapped_counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">extracted_counts</span>
            
            <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size_on_detector</span><span class="p">))</span>
            
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pixels_slitlet_parallel</span><span class="p">):</span>
                <span class="n">noise</span><span class="p">[</span><span class="n">k</span><span class="p">:</span> <span class="n">k</span> <span class="o">+</span> <span class="n">num_pixels_on_detector</span><span class="p">]</span> <span class="o">+=</span> \
                    <span class="n">noise_counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">*</span> <span class="n">n_pixels_slitlet_parallel</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
                    
            <span class="n">extracted_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="n">offset</span><span class="p">:])</span>
            <span class="n">overlapped_noise_counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">extracted_noise</span>
                    
            <span class="n">sed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size_on_detector</span><span class="p">))</span>
            
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pixels_slitlet_parallel</span><span class="p">):</span>
                <span class="n">sed</span><span class="p">[</span><span class="n">k</span><span class="p">:</span> <span class="n">k</span> <span class="o">+</span> <span class="n">num_pixels_on_detector</span><span class="p">]</span> <span class="o">+=</span> \
                    <span class="n">sed_counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">*</span> <span class="n">n_pixels_slitlet_parallel</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span>
                    
            <span class="n">extracted_sed</span> <span class="o">=</span> <span class="n">sed</span><span class="p">[</span><span class="n">offset</span><span class="p">:]</span>
            <span class="n">overlapped_sed_counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">extracted_sed</span>
            
    <span class="k">return</span> <span class="n">overlapped_counts_array</span><span class="p">,</span> <span class="n">overlapped_noise_counts_array</span><span class="p">,</span> <span class="n">overlapped_sed_counts_array</span>


<div class="viewcode-block" id="PostProcess">
<a class="viewcode-back" href="../../api.html#galaxyGeniusMSA.postprocess.PostProcess">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PostProcess</span><span class="p">:</span>
    
<div class="viewcode-block" id="PostProcess.__init__">
<a class="viewcode-back" href="../../api.html#galaxyGeniusMSA.postprocess.PostProcess.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subhaloID</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PostProcess class for handling post-processing of JWST MSA-3D simulation.</span>
<span class="sd">        It loads the data cube and other relevant data, applying astrophysical and instrumental transformations,</span>
<span class="sd">        and producing synthetic observables compatible with JWST/NIRSpec MSA observations. </span>
<span class="sd">        Finally, it saves the resulting MSA data tensor and other relevant files to the result directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        subhaloID : int</span>
<span class="sd">            The identifier of the target subhalo to be post-processed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">subhaloID</span> <span class="o">=</span> <span class="n">subhaloID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataDir</span> <span class="o">=</span> <span class="n">galaxygenius_data_dir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_count_constants</span><span class="p">()</span></div>

        
    <span class="k">def</span><span class="w"> </span><span class="nf">__init_count_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># dimension conversion without real values</span>
        
        <span class="n">f_lam_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">MJy</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">sr</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">f_lam_unit</span> <span class="o">=</span> <span class="n">f_lam_unit</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">erg</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">sr</span><span class="p">)</span>
        
        <span class="c1"># const_factor = np.pi * (u.m / 2)**2 * u.arcsec**2 / (const.h * const.c)</span>
        <span class="n">const_factor</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
        
        <span class="n">count_constants</span> <span class="o">=</span> <span class="n">f_lam_unit</span> <span class="o">*</span> <span class="n">const_factor</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">**</span><span class="mi">2</span>
        
        <span class="n">count_constants</span> <span class="o">=</span> <span class="n">count_constants</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="o">**-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">count_constants</span> <span class="o">=</span> <span class="n">count_constants</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">__init_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataCubeDir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cosmology</span> <span class="o">=</span> <span class="n">Cosmology</span><span class="o">.</span><span class="n">from_format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;cosmology&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mapping&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;cosmology&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmology</span> <span class="c1"># convert to astropy cosmology object</span>
        
        <span class="c1"># limit the number of threads for numba</span>
        <span class="n">numba</span><span class="o">.</span><span class="n">set_num_threads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;numThreads&#39;</span><span class="p">])</span>
        
        <span class="c1"># limit the number of threads for numpy</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMP_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;numThreads&#39;</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MKL_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;numThreads&#39;</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OPENBLAS_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;numThreads&#39;</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;NUMEXPR_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;numThreads&#39;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">subhalo_info</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataCubeDir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Subhalo_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subhaloID</span><span class="si">}</span><span class="s1">.json&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logging</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;galaxyGeniusMSA.log&#39;</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">=</span> <span class="s1">&#39;./cache&#39;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataCubeDir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;dataCubes&#39;</span><span class="p">,</span> <span class="s1">&#39;MSA_mock&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">__init_stpsf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">stpsf</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">poppy</span>
            
            <span class="c1"># speed up PSF generation by using multiprocessing and fftw</span>
            <span class="n">poppy</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">use_multiprocessing</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">poppy</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">n_processes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;numThreads&#39;</span><span class="p">]</span>
            
            <span class="n">stpsf</span><span class="o">.</span><span class="n">setup_logging</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="s1">&#39;stpsf.log&#39;</span><span class="p">))</span>
            
            <span class="n">nrs</span> <span class="o">=</span> <span class="n">stpsf</span><span class="o">.</span><span class="n">NIRSpec</span><span class="p">()</span>
            <span class="n">nrs</span><span class="o">.</span><span class="n">image_mask</span> <span class="o">=</span> <span class="s1">&#39;Single MSA open shutter&#39;</span> <span class="c1"># MSA use step and dithers intead of multiple slits</span>
            <span class="n">nrs</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;imaging&#39;</span>
            <span class="n">nrs</span><span class="o">.</span><span class="n">disperser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;disperser&#39;</span><span class="p">]</span>
            <span class="n">nrs</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span>
        
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error getting PSF cube from STPSF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">nrs</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">__init_consts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">pixel_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pixelScale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
        
        <span class="c1"># in pixels, center offset for center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_perpendicular</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;offsetPerpendicular&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span> <span class="o">/</span> <span class="n">pixel_scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_parallel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;offsetParallel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span> <span class="o">/</span> <span class="n">pixel_scale</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">rescale_ratio_perpendicular</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixel_scale</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ditherSize&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">))</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rescale_ratio_parallel</span> <span class="o">=</span> <span class="mf">1.</span>
        
        <span class="c1"># in arcsec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size_perpendicular</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nDithers&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ditherSize&#39;</span><span class="p">]</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nSlitlets&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;slitletSizePerpendicular&#39;</span><span class="p">]</span> <span class="o">+</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nSlitlets&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;supportBarSize&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size_parallel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nSteps&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;slitletSizeParallel&#39;</span><span class="p">]</span>
        
        <span class="c1"># in pixels ditherSize is 0.075, changed from original 0.1 arcsec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_perpendicular</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size_perpendicular</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ditherSize&#39;</span><span class="p">])</span> <span class="c1"># dither size is pixel scale</span>
        <span class="c1"># considered pixel in parallel direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_parallel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size_parallel</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pixelScale&#39;</span><span class="p">])</span>
        
        <span class="c1"># number of pixel in one slitlet in parallel direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_slitlet_parallel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;slitletSizeParallel&#39;</span><span class="p">]</span> \
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pixelScale&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_output_parallel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_parallel</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_slitlet_parallel</span>
        
        <span class="c1"># 40, 18</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_exposure_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_perpendicular</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_parallel</span><span class="p">,</span>
        <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nDithers&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        
        
        <span class="c1"># modify the exposure array for each dither</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nDithers&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_exposure_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_exposure_array</span><span class="p">[</span><span class="o">-</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">i</span>
        
        <span class="c1"># 40, 9</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_exposure_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_perpendicular</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_output_parallel</span><span class="p">,</span>
        <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nDithers&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nDithers&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_exposure_output</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_exposure_output</span><span class="p">[</span><span class="o">-</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">i</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">begin_wave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;minWaveOutput&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">begin_wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">begin_wave</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">end_wave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;maxWaveOutput&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_wave</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># considered box length in pixels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxlength_in_pixel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;displayBoxSize&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pixelScale&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">__init_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">dispersion</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataDir</span><span class="p">,</span> 
            <span class="sa">f</span><span class="s1">&#39;nirspec/jwst_nirspec_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;disperser&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">_disp.fits&#39;</span>
        <span class="p">)</span>
        
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dispersion</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            
            <span class="n">wavelengths</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">4</span>
            <span class="n">dlds</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;dlds&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">4</span>
            <span class="n">resolutions</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>
            
            <span class="n">wavelengths</span> <span class="o">=</span> <span class="n">wavelengths</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">dlds</span> <span class="o">=</span> <span class="n">dlds</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">resolutions</span> <span class="o">=</span> <span class="n">resolutions</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">interp_dispersion</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
            <span class="n">wavelengths</span><span class="p">,</span>
            <span class="n">dlds</span><span class="p">,</span> 
            <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">interp_resolution</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
            <span class="n">wavelengths</span><span class="p">,</span>
            <span class="n">resolutions</span><span class="p">,</span>
            <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span>
        <span class="p">)</span>
        
        <span class="n">throughput</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataDir</span><span class="p">,</span> 
            <span class="sa">f</span><span class="s1">&#39;nirspec/jwst_nirspec_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">_trans.fits&#39;</span>
        <span class="p">)</span>
        
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">throughput</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            
            <span class="n">wavelengths</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">4</span>
            <span class="n">throughputs</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;throughput&#39;</span><span class="p">]</span>
            
            <span class="n">wavelengths</span> <span class="o">=</span> <span class="n">wavelengths</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">throughputs</span> <span class="o">=</span> <span class="n">throughputs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">throughput_dict</span> <span class="o">=</span> <span class="n">Dict</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
            <span class="n">key_type</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">unicode_type</span><span class="p">,</span>
            <span class="n">value_type</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">float32</span><span class="p">[:]</span>
        <span class="p">)</span>
        
        <span class="c1"># numba compatible dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">throughput_dict</span><span class="p">[</span><span class="s1">&#39;wavelengths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wavelengths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">throughput_dict</span><span class="p">[</span><span class="s1">&#39;throughput&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">throughputs</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">interp_throughput</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
            <span class="n">wavelengths</span><span class="p">,</span>
            <span class="n">throughputs</span><span class="p">,</span>
            <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span>
        <span class="p">)</span>
        
<div class="viewcode-block" id="PostProcess.input_bkg_interp">
<a class="viewcode-back" href="../../api.html#galaxyGeniusMSA.postprocess.PostProcess.input_bkg_interp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">input_bkg_interp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interp_bkg</span><span class="p">:</span> <span class="n">interp1d</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attach a background interpolation function to the PostProcess instance.</span>

<span class="sd">        This method allows the user to supply a precomputed background interpolation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        interp_bkg : interp1d</span>
<span class="sd">            Interpolated function of background vs. wavelength (e.g. created using scipy.interpolate.interp1d).</span>
<span class="sd">            Should accept an array of wavelengths (in angstrom) and return the background value(s) in MJy/sr.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">input_bkg_called</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interp_bkg</span> <span class="o">=</span> <span class="n">interp_bkg</span></div>

        
<div class="viewcode-block" id="PostProcess.input_psf">
<a class="viewcode-back" href="../../api.html#galaxyGeniusMSA.postprocess.PostProcess.input_psf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">input_psf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psf_cube</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method allows the user to supply a precomputed PSF cube with the same oversample in the config.</span>
<span class="sd">        PSF cube should be in a 3-dimensional array with dimensions (number of wavelengths, number of pixels, number of pixels).</span>
<span class="sd">        The number of wavelengths should be the same as the number of wavelengths in the data cube.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        psf_cube : np.ndarray</span>
<span class="sd">            PSF cube</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">input_psf_called</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_psf_cube</span> <span class="o">=</span> <span class="n">psf_cube</span></div>

        
<div class="viewcode-block" id="PostProcess.input_dataCube">
<a class="viewcode-back" href="../../api.html#galaxyGeniusMSA.postprocess.PostProcess.input_dataCube">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">input_dataCube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataCube_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                       <span class="n">viewing_angle</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a data cube file and initialize PostProcess attributes.</span>

<span class="sd">        This method sets up the PostProcess instance to use a specific dataCube file,</span>
<span class="sd">        extracting metadata, initializing relevant paths, configuration,</span>
<span class="sd">        constants, and data required for further processing and analysis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dataCube_path : str</span>
<span class="sd">            The file path to the data cube (output by SKIRT, in .fits format) to be loaded.</span>
<span class="sd">        viewing_angle : tuple[float, float] | list[float, float] | None, optional</span>
<span class="sd">            The inclination (in degree) and azimuth (in degree) viewing angles to be associated with this data cube.</span>
<span class="sd">            If None, the angles will be extracted from the dataCube_path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dataCubeDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dataCube_path</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_paths</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_consts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_data</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dataCube_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data cube file </span><span class="si">{</span><span class="n">dataCube_path</span><span class="si">}</span><span class="s1"> does not exist.&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">viewing_angle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">viewing_angle</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> \
                <span class="sa">f</span><span class="s1">&#39;viewing angle should be in [inclination, azimuth] pair&#39;</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">viewing_angle</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">viewing_angle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dataCube_path</span><span class="p">)</span>
            <span class="n">view_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viewing_angle</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;inclinations&#39;</span><span class="p">][</span><span class="n">view_idx</span><span class="p">],</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;azimuths&#39;</span><span class="p">][</span><span class="n">view_idx</span><span class="p">]]</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Viewing at inclination: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">viewing_angle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> deg, azimuth: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">viewing_angle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> deg&#39;</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dataCube_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dataCube</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;grid_points&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">4</span> <span class="c1"># in angstrom</span>
        
        <span class="c1"># slightly extend to avoid error on interp</span>
        <span class="n">begin_wave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_wave</span> <span class="o">-</span> <span class="mi">20</span>
        <span class="n">end_wave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_wave</span> <span class="o">+</span> <span class="mi">20</span>
        
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span> <span class="o">&gt;</span> <span class="n">begin_wave</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span> <span class="o">&lt;</span> <span class="n">end_wave</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dataCube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataCube</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataCube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataCube</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>

        
        
<div class="viewcode-block" id="PostProcess.input_subhalo_info">
<a class="viewcode-back" href="../../api.html#galaxyGeniusMSA.postprocess.PostProcess.input_subhalo_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">input_subhalo_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subhalo_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add or update subhalo information.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        subhalo_info : dict</span>
<span class="sd">            A dictionary containing subhalo-related properties or metadata to be associated</span>
<span class="sd">            with the object. These may include information such as mass_stars, vel_x, vel_y, vel_z, etc.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">subhalo_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">subhalo_info</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">__save_PSF_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psf_cube</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">savefilename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        
    
        <span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">()</span>
        <span class="n">primary_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">psf_cube</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">primary_hdu</span><span class="o">.</span><span class="n">header</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;oversamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;oversample&#39;</span><span class="p">],</span> <span class="s1">&#39;Oversampling factor&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;pixelsca&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pixelScale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;oversample&#39;</span><span class="p">],</span>
                              <span class="s1">&#39;Pixel scale after oversampling, in arcsec&#39;</span><span class="p">)</span>
        <span class="n">hdulist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">primary_hdu</span><span class="p">)</span>

        <span class="n">col</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;wavelengths&#39;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
        <span class="n">hdu_wavelengths</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">([</span><span class="n">col</span><span class="p">])</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">hdu_wavelengths</span><span class="o">.</span><span class="n">header</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;angstrom&#39;</span><span class="p">,</span> <span class="s1">&#39;Wavelength unit&#39;</span><span class="p">)</span>
        <span class="n">hdulist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu_wavelengths</span><span class="p">)</span>
        
        <span class="n">hdulist</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">savefilename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">__save_PSF_bandpass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psf_bandpass</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">savefilename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># un-used, bandpass image is not used</span>
        <span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">()</span>
        <span class="n">primary_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">psf_bandpass</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">primary_hdu</span><span class="o">.</span><span class="n">header</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;displayBackgroundFilter&#39;</span><span class="p">],</span> <span class="s1">&#39;Filter&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;oversamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;oversample&#39;</span><span class="p">],</span> <span class="s1">&#39;Oversampling factor&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;pixelsca&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pixelScale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;oversample&#39;</span><span class="p">],</span>
                              <span class="s1">&#39;Pixel scale after oversampling, in arcsec&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;PSF is rescaled to match dataCube&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="n">hdulist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">primary_hdu</span><span class="p">)</span>
        
        <span class="n">hdulist</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">savefilename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">__psf_bandpass_from_stpsf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="c1"># un-used, bandpass image is not used</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">nrc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__init_stpsf</span><span class="p">()</span>
        
        <span class="n">bandpass_psf</span> <span class="o">=</span> <span class="n">nrc</span><span class="o">.</span><span class="n">calc_psf</span><span class="p">(</span><span class="n">oversample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;oversample&#39;</span><span class="p">])</span>
        
        <span class="n">psf_array</span> <span class="o">=</span> <span class="n">bandpass_psf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">psf_header</span> <span class="o">=</span> <span class="n">bandpass_psf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">psf_pixel_scale</span> <span class="o">=</span> <span class="n">psf_header</span><span class="p">[</span><span class="s1">&#39;pixelscl&#39;</span><span class="p">]</span> <span class="c1"># after oversampling</span>
        
        <span class="c1"># cube pixel scale after oversampling</span>
        <span class="n">cube_pixel_scale</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pixelScale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;oversample&#39;</span><span class="p">])</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">psf_pixel_scale</span> <span class="o">/</span> <span class="n">cube_pixel_scale</span>
        
        <span class="c1"># rescale to match pixel scale with cube</span>
        <span class="n">psf_array</span> <span class="o">=</span> <span class="n">rescale</span><span class="p">(</span><span class="n">psf_array</span><span class="p">,</span> <span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">ratio</span><span class="p">))</span>
        <span class="n">psf_array</span> <span class="o">=</span> <span class="n">psf_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">psf_array</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__psf_from_stpsf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        
        <span class="n">nrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__init_stpsf</span><span class="p">()</span>
        
        <span class="n">waves</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
        <span class="n">psf_cube</span> <span class="o">=</span> <span class="n">nrs</span><span class="o">.</span><span class="n">calc_datacube_fast</span><span class="p">(</span><span class="n">waves</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;oversample&#39;</span><span class="p">])</span>
        <span class="n">psf_cube</span> <span class="o">=</span> <span class="n">psf_cube</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        
        <span class="n">psf_cube</span> <span class="o">=</span> <span class="n">psf_cube</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">psf_cube</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_check_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_psf_cube</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">),</span> \
            <span class="sa">f</span><span class="s1">&#39;PSF cube and wavelengths size do not match, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_psf_cube</span><span class="p">)</span><span class="si">}</span><span class="s1"> vs. </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            
    <span class="k">def</span><span class="w"> </span><span class="nf">_check_existing_psf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">oversample</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        
        <span class="n">cond_1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">)</span>
        <span class="n">cond_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">)</span>
        <span class="n">cond_3</span> <span class="o">=</span> <span class="n">oversample</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;oversample&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">cond_1</span> <span class="ow">and</span> <span class="n">cond_2</span> <span class="ow">and</span> <span class="n">cond_3</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>    
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_PSF_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;input_psf_called&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_psf_called</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_size</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Use input PSF cube.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psf_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_psf_cube</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">psf_cube_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="s1">&#39;psf_cube.fits&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">psf_cube_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">psf_cube_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">oversample</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;oversamp&#39;</span><span class="p">]</span>
                <span class="n">wavelengths</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wavelengths&#39;</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_existing_psf</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">oversample</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Use stored PSF cube in </span><span class="si">{</span><span class="n">psf_cube_path</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
                    <span class="n">psf_cube</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PSF cube in cache does not match the configuration, getting new PSF cube from STPSF&#39;</span><span class="p">)</span>
                    <span class="n">psf_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__psf_from_stpsf</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__save_PSF_cube</span><span class="p">(</span><span class="n">psf_cube</span><span class="p">,</span> <span class="n">psf_cube_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No PSF cube in cache, getting new PSF cube from STPSF&#39;</span><span class="p">)</span>
            <span class="n">psf_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__psf_from_stpsf</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__save_PSF_cube</span><span class="p">(</span><span class="n">psf_cube</span><span class="p">,</span> <span class="n">psf_cube_path</span><span class="p">)</span>
        
        <span class="n">psf_cube</span> <span class="o">=</span> <span class="n">psf_cube</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_cube</span> <span class="o">=</span> <span class="n">psf_cube</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_PSF_bandpass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="c1"># un-used, bandpass image is not used</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;input_psf_called&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_psf_called</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_bandpass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Use input bandpass PSF.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_bandpass</span>
        
        <span class="n">psf_bandpass_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="s1">&#39;psf_bandpass.fits&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">psf_bandpass_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Use cached bandpass PSF.&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">psf_bandpass_path</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">psf_bandpass</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting bandpass PSF from STPSF&#39;</span><span class="p">)</span>
            <span class="n">psf_bandpass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__psf_bandpass_from_stpsf</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__save_PSF_bandpass</span><span class="p">(</span><span class="n">psf_bandpass</span><span class="p">,</span> <span class="n">psf_bandpass_path</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_bandpass</span> <span class="o">=</span> <span class="n">psf_bandpass</span>
    
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_shift_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">dy</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span> <span class="c1"># 3d array</span>
        
        <span class="n">y1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">h</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">w</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
        
        <span class="n">result</span><span class="p">[:,</span> <span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:,</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">dy</span><span class="p">:</span><span class="n">y2</span> <span class="o">-</span> <span class="n">dy</span><span class="p">,</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">dx</span><span class="p">:</span><span class="n">x2</span> <span class="o">-</span> <span class="n">dx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_rotate_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">angle</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        
        <span class="c1"># We rotate each slice (cube[z, :, :]) in xy spatial plane by the given angle</span>
        <span class="n">rotated_cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">rotated_cube</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span>
                <span class="n">cube</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                <span class="n">angle</span><span class="p">,</span> 
                <span class="n">resize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> 
                <span class="n">cval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
                <span class="n">preserve_range</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">rotated_cube</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_transform_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        
        <span class="c1"># match the shape of the cube to the number of pixels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_perpendicular</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cube</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="c1"># to odd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cube</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="c1"># to even</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_parallel</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cube</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># to odd</span>
        <span class="k">else</span><span class="p">:</span>    
            <span class="k">if</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cube</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># to even</span>
        
        <span class="c1"># rotate</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;rotate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">angle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">))</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotate_cube</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
            
        <span class="c1"># shift</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_perpendicular</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_parallel</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shift_cube</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_perpendicular</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_parallel</span><span class="p">)</span>
        
        <span class="c1"># rescale</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="n">rescale</span><span class="p">(</span>
            <span class="n">cube</span><span class="p">,</span> 
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale_ratio_perpendicular</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale_ratio_parallel</span><span class="p">),</span>
            <span class="n">anti_aliasing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
            
        <span class="k">return</span> <span class="n">cube</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_process_spatial_dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        
        <span class="n">cube</span> <span class="o">=</span> <span class="n">_numba_convolve_fft_static</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataCube</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_cube</span>
        <span class="p">)</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_downsample_static</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;oversample&#39;</span><span class="p">])</span>
        
        <span class="n">cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_padding_cube</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_cube</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
        
        <span class="n">slice_center_idx_perpendicular</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">slice_center_idx_parallel</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        
        <span class="n">slice_perpendicular</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span>
            <span class="n">slice_center_idx_perpendicular</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_perpendicular</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">slice_center_idx_perpendicular</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_perpendicular</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="p">)</span>
        
        <span class="n">slice_parallel</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span>
            <span class="n">slice_center_idx_parallel</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_parallel</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">slice_center_idx_parallel</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_parallel</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">cube</span><span class="p">[:,</span> <span class="n">slice_perpendicular</span><span class="p">,</span> <span class="n">slice_parallel</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_waves_by_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># get waves corresponding to the resolution (output wavelengths for spectra)</span>
        
        <span class="n">waves_corresponding_to_resolution</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">begin_wave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_wave</span>
        <span class="n">end_wave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_wave</span>
        
        <span class="n">waves_corresponding_to_resolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">begin_wave</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">begin_wave_resol</span> <span class="o">=</span> <span class="n">begin_wave</span>
            <span class="n">delta_wave</span> <span class="o">=</span> <span class="n">begin_wave_resol</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_resolution</span><span class="p">(</span><span class="n">begin_wave_resol</span><span class="p">)</span>
            <span class="n">end_wave_resol</span> <span class="o">=</span> <span class="n">begin_wave_resol</span> <span class="o">+</span> <span class="n">delta_wave</span>
            
            <span class="n">waves_corresponding_to_resolution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end_wave_resol</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">end_wave_resol</span> <span class="o">&gt;</span> <span class="n">end_wave</span><span class="p">:</span>
                <span class="k">break</span>
            
            <span class="n">begin_wave</span> <span class="o">=</span> <span class="n">end_wave_resol</span>
        
        <span class="n">waves_corresponding_to_resolution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">waves_corresponding_to_resolution</span><span class="p">,</span> 
                                                     <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">waves_by_resolution</span> <span class="o">=</span> <span class="n">waves_corresponding_to_resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of wavelengths by resolution: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waves_by_resolution</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_waves_at_pixel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">waves_at_pixel</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">begin_wave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_wave</span>
        <span class="n">end_wave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_wave</span>
        <span class="n">waves_at_pixel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">begin_wave</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">begin_wave_pixel</span> <span class="o">=</span> <span class="n">begin_wave</span>
            <span class="n">delta_wave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_dispersion</span><span class="p">(</span><span class="n">begin_wave_pixel</span><span class="p">)</span>
            <span class="n">end_wave_pixel</span> <span class="o">=</span> <span class="n">begin_wave_pixel</span> <span class="o">+</span> <span class="n">delta_wave</span>
            
            <span class="n">waves_at_pixel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end_wave_pixel</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">end_wave_pixel</span> <span class="o">&gt;</span> <span class="n">end_wave</span><span class="p">:</span>
                <span class="k">break</span>
            
            <span class="n">begin_wave</span> <span class="o">=</span> <span class="n">end_wave_pixel</span>

        <span class="n">waves_at_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">waves_at_pixel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">waves_at_pixel</span> <span class="o">=</span> <span class="n">waves_at_pixel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of wavelengths by pixel: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waves_at_pixel</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_jwst_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">background_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
        
            <span class="kn">from</span><span class="w"> </span><span class="nn">jwst_backgrounds</span><span class="w"> </span><span class="kn">import</span> <span class="n">jbt</span>
            
            <span class="n">ra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;obsRA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;obsDec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="mf">4.4</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span>
            <span class="n">thisday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;thisDay&#39;</span><span class="p">]</span>
            
            <span class="n">jbt</span><span class="o">.</span><span class="n">get_background</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">thisday</span><span class="o">=</span><span class="n">thisday</span><span class="p">,</span> <span class="n">plot_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                            <span class="n">plot_bathtub</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">write_bathtub</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">write_background</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">background_file</span><span class="o">=</span><span class="n">background_path</span><span class="p">)</span>
            
            <span class="n">bkg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">background_path</span><span class="p">)</span>
            <span class="n">wavelength</span> <span class="o">=</span> <span class="n">bkg</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">4</span> <span class="c1"># in angstrom</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">bkg</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="c1"># in MJy/sr</span>
            
            <span class="n">wavelength</span> <span class="o">=</span> <span class="n">wavelength</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">interp_bkg</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                <span class="n">wavelength</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error getting background emission file from JWST Background Tool (JBT): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_bkg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;useJBT&#39;</span><span class="p">]:</span>
            
            <span class="n">suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;obsRA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;obsDec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;thisDay&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.txt&quot;</span>
            
            <span class="n">background_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">,</span> <span class="s1">&#39;background&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">background_path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Use cached background emission file.&#39;</span><span class="p">)</span>
                <span class="n">bkg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">background_path</span><span class="p">)</span>
                <span class="n">wavelength</span> <span class="o">=</span> <span class="n">bkg</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">4</span> <span class="c1"># in angstrom</span>
                <span class="n">flux</span> <span class="o">=</span> <span class="n">bkg</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
                
                <span class="n">wavelength</span> <span class="o">=</span> <span class="n">wavelength</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">flux</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">interp_bkg</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                    <span class="n">wavelength</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span>
                <span class="p">)</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting background emission file from JWST Background Tool (JBT).&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_jwst_background</span><span class="p">(</span><span class="n">background_path</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;interp_bkg_called&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_bkg_called</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please call PostProcess.input_bkg() to provide a background interpolation.&#39;</span><span class="p">)</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_noise_static</span><span class="p">(</span><span class="n">spectrum_count_rates</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">bkg_count_rates</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                          <span class="n">n_exposure</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">exposure_time</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                          <span class="n">dark_current</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">read_out</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        
        <span class="n">counts</span> <span class="o">=</span> <span class="n">spectrum_count_rates</span> <span class="o">*</span> <span class="n">n_exposure</span> <span class="o">*</span> <span class="n">exposure_time</span>
        <span class="n">bkg_counts</span> <span class="o">=</span> <span class="n">bkg_count_rates</span> <span class="o">*</span> <span class="n">n_exposure</span> <span class="o">*</span> <span class="n">exposure_time</span>
        <span class="n">dark_counts</span> <span class="o">=</span> <span class="n">dark_current</span> <span class="o">*</span> <span class="n">n_exposure</span> <span class="o">*</span> <span class="n">exposure_time</span>
        
        <span class="n">dark_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dark_counts</span><span class="p">)</span>
        <span class="n">readout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">read_out</span><span class="p">)</span>
        
        <span class="n">counts_val</span><span class="p">,</span> <span class="n">noise_counts_val</span> <span class="o">=</span> <span class="n">_add_noise_numba</span><span class="p">(</span>
            <span class="n">counts</span><span class="p">,</span> <span class="n">bkg_counts</span><span class="p">,</span> <span class="n">dark_counts</span><span class="p">,</span>
            <span class="n">readout</span><span class="p">,</span> <span class="n">n_exposure</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">counts_val</span><span class="p">,</span> <span class="n">noise_counts_val</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_rebin_fluxes_and_noise_array</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">wavelengths_in</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">fluxes_in_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">noise_in_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">sed_in_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">wavelengths_out</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        
        <span class="n">new_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">fluxes_in_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fluxes_in_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavelengths_out</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">fluxes_out_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fluxes_in_array</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">noise_out_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">noise_in_array</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">sed_out_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">sed_in_array</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">new_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">new_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                
                <span class="n">fluxes_out</span><span class="p">,</span> <span class="n">noise_out</span><span class="p">,</span> <span class="n">sed_out</span> <span class="o">=</span> <span class="n">_rebin_fluxes_and_noise_numba</span><span class="p">(</span>
                    <span class="n">wavelengths_in</span><span class="p">,</span> <span class="n">fluxes_in_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">noise_in_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">sed_in_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">wavelengths_out</span><span class="p">)</span>
                <span class="n">fluxes_out_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxes_out</span>
                <span class="n">noise_out_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise_out</span>
                <span class="n">sed_out_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sed_out</span>
                
        <span class="k">return</span> <span class="n">fluxes_out_array</span><span class="p">,</span> <span class="n">noise_out_array</span><span class="p">,</span> <span class="n">sed_out_array</span>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_to_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">counts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">noise_counts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                         <span class="n">sed_counts</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n_exposure</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">exposure_time</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
        
        <span class="n">delta_waves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">)</span>
        
        <span class="n">middle_waves</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavelengths</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">wavelengths</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">efficiency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_throughput</span><span class="p">(</span><span class="n">middle_waves</span><span class="p">)</span>
        
        <span class="n">energy_per_photon</span> <span class="o">=</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">middle_waves</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span>
        
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_exposure</span> <span class="o">*</span> <span class="n">exposure_time</span> <span class="o">*</span>\
            <span class="n">delta_waves</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span> <span class="o">*</span> <span class="n">efficiency</span>
        
        <span class="n">flux_lam</span> <span class="o">=</span> <span class="p">(</span><span class="n">counts</span> <span class="o">*</span> <span class="n">energy_per_photon</span><span class="p">)</span> <span class="o">/</span> <span class="n">sensitivity</span>
        <span class="n">noise_flux_lam</span> <span class="o">=</span> <span class="p">(</span><span class="n">noise_counts</span> <span class="o">*</span> <span class="n">energy_per_photon</span><span class="p">)</span> <span class="o">/</span> <span class="n">sensitivity</span>
        <span class="n">sed_flux_lam</span> <span class="o">=</span> <span class="p">(</span><span class="n">sed_counts</span> <span class="o">*</span> <span class="n">energy_per_photon</span><span class="p">)</span> <span class="o">/</span> <span class="n">sensitivity</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;flux_lambda&#39;</span><span class="p">:</span>
            
            <span class="n">flux_lam</span> <span class="o">=</span> <span class="n">flux_lam</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">erg</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span>
            <span class="n">noise_flux_lam</span> <span class="o">=</span> <span class="n">noise_flux_lam</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">erg</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span>
            <span class="n">sed_flux_lam</span> <span class="o">=</span> <span class="n">sed_flux_lam</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">erg</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">flux_lam</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">noise_flux_lam</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">sed_flux_lam</span><span class="o">.</span><span class="n">value</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;flux_nu&#39;</span><span class="p">:</span>
            
            <span class="n">flux_nu</span> <span class="o">=</span> <span class="p">(</span><span class="n">middle_waves</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">flux_lam</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span>
            <span class="n">noise_flux_nu</span> <span class="o">=</span> <span class="p">(</span><span class="n">middle_waves</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">noise_flux_lam</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span>
            <span class="n">sed_flux_nu</span> <span class="o">=</span> <span class="p">(</span><span class="n">middle_waves</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sed_flux_lam</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span>
            
            <span class="n">flux_nu</span> <span class="o">=</span> <span class="n">flux_nu</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="p">)</span>
            <span class="n">noise_flux_nu</span> <span class="o">=</span> <span class="n">noise_flux_nu</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="p">)</span>
            <span class="n">sed_flux_nu</span> <span class="o">=</span> <span class="n">sed_flux_nu</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">flux_nu</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">noise_flux_nu</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">sed_flux_nu</span><span class="o">.</span><span class="n">value</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_to_flux_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">counts_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                               <span class="n">noise_counts_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sed_counts_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        
        <span class="n">fluxes_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">counts_array</span><span class="p">)</span>
        <span class="n">noise_fluxes_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">noise_counts_array</span><span class="p">)</span>
        <span class="n">sed_fluxes_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">sed_counts_array</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">counts_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">range</span><span class="p">(</span><span class="n">counts_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
            
            <span class="n">n_exposure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_exposure_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">n_exposure</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fluxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
                <span class="n">noise_fluxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">fluxes_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxes</span>
                <span class="n">noise_fluxes_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise_fluxes</span>
                <span class="n">sed_fluxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
                <span class="n">sed_fluxes_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sed_fluxes</span>
                <span class="k">continue</span>
            
            <span class="n">exposure_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exposureTime&#39;</span><span class="p">]</span>
            <span class="n">fluxes</span><span class="p">,</span> <span class="n">noise_fluxes</span><span class="p">,</span> <span class="n">sed_fluxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_flux</span><span class="p">(</span>
                <span class="n">wavelengths</span><span class="p">,</span> <span class="n">counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">noise_counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">sed_counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
                <span class="n">n_exposure</span><span class="p">,</span> <span class="n">exposure_time</span>
            <span class="p">)</span>
            <span class="n">fluxes_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxes</span>
            <span class="n">noise_fluxes_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise_fluxes</span>
            <span class="n">sed_fluxes_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sed_fluxes</span>
        
        <span class="k">return</span> <span class="n">fluxes_array</span><span class="p">,</span> <span class="n">noise_fluxes_array</span><span class="p">,</span> <span class="n">sed_fluxes_array</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_save_dataTensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataTensor</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">savefilename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        
        <span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">()</span>
        <span class="n">primary_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">()</span>
        <span class="n">hdulist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">primary_hdu</span><span class="p">)</span>
        
        <span class="n">unit_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span>
        <span class="n">unit_comment_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;electron&#39;</span><span class="p">:</span> <span class="s1">&#39;Unit of image, in electron counts&#39;</span><span class="p">,</span>
            <span class="s1">&#39;flux_lambda&#39;</span><span class="p">:</span> <span class="s1">&#39;Unit of image, in erg / cm^2 / s / angstrom&#39;</span><span class="p">,</span>
            <span class="s1">&#39;flux_nu&#39;</span><span class="p">:</span> <span class="s1">&#39;Unit of image, in Jy&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">unit_comment</span> <span class="o">=</span> <span class="n">unit_comment_dict</span><span class="p">[</span><span class="n">unit_type</span><span class="p">]</span>
        
        <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;SNAPNUM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;snapNum&#39;</span><span class="p">],</span> <span class="s1">&#39;Snapshot ID&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;subhaloID&#39;</span><span class="p">],</span> <span class="s1">&#39;Subhalo ID&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;MASS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;stellarMass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> 
                          <span class="s1">&#39;Subhalo stellar mass, in log10 scale (Msun)&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;INSTRU&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;NIRSpec MSA&#39;</span><span class="p">,</span> <span class="s1">&#39;Instrument&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;DISP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;disperser&#39;</span><span class="p">],</span> <span class="s1">&#39;Disperser&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">],</span> <span class="s1">&#39;Filter&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;APERTURE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;Aperture size, in meter&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;UNIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">],</span> <span class="n">unit_comment</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;REDSHIFT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;viewRedshift&#39;</span><span class="p">],</span> <span class="s1">&#39;Viewing redshift&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;inLocal&#39;</span><span class="p">]:</span>
            <span class="n">cosmology</span> <span class="o">=</span> <span class="s1">&#39;LocalUniverseCosmology&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cosmology</span> <span class="o">=</span> <span class="s1">&#39;Planck15&#39;</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;COSMO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cosmology</span><span class="p">,</span> <span class="s1">&#39;Cosmology&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;BOXSIZE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;boxLength&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;Box size, in pc&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;FOV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fieldOfView&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;Field of view, in arcsec&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;PHYFOV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fovSize&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;Physical field of view, in pc&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;LUMIDIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;lumiDis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Mpc</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;Luminosity distance, in Mpc&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;PIXELSC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pixelScale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;Detector pixel scale, in arcsec&#39;</span><span class="p">)</span>
        <span class="n">slitsize</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slitletSizeParallel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slitletSizePerpendicular&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;SLITSIZE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">slitsize</span><span class="p">,</span> <span class="s1">&#39;slitlet size, in arcsec (para, perp)&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;BARSIZE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;supportBarSize&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;Support bar size, in arcsec&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;DITHERSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ditherSize&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;Dither size, in arcsec&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NDITHERS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nDithers&#39;</span><span class="p">],</span> <span class="s1">&#39;Number of dithers&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NSLITLET&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nSlitlets&#39;</span><span class="p">],</span> <span class="s1">&#39;Number of slitlets&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NSTEPS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nSteps&#39;</span><span class="p">],</span> <span class="s1">&#39;Number of steps&#39;</span><span class="p">)</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;ROTATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;rotate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;Rotation angle, in deg&#39;</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;offsetParallel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;offsetPerpendicular&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;OFFSET&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="s1">&#39;Offset, in arcsec (para, perp)&#39;</span><span class="p">)</span>
        <span class="n">hdu_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dataTensor</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
        <span class="n">hdulist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu_data</span><span class="p">)</span>
        
        <span class="n">hdu_exposure</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_exposure_array</span><span class="p">)</span>
        <span class="n">hdulist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu_exposure</span><span class="p">)</span>
        
        <span class="n">hdulist</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">savefilename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_assemble_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                       <span class="n">signal_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                       <span class="n">noise_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                       <span class="n">sed_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        
        <span class="c1"># middle wavelength of the bin</span>
        <span class="n">wavelengths</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavelengths</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">wavelengths</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        
        <span class="n">dataTensor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
            <span class="n">signal_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">signal_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="mi">4</span><span class="p">,</span> 
            <span class="n">signal_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">))</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">signal_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">signal_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">dataTensor</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">wavelengths</span>
                <span class="n">dataTensor</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">dataTensor</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">dataTensor</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sed_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                
        <span class="k">return</span> <span class="n">dataTensor</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_process_spectral_dimension</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">msa_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        
        <span class="n">spectrum_counts_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_perpendicular</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_parallel</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">waves_at_pixel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">))</span>
        <span class="n">noise_counts_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_perpendicular</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_parallel</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">waves_at_pixel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">))</span>
        <span class="n">sed_counts_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_perpendicular</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_parallel</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">waves_at_pixel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">))</span>
        
        <span class="n">exposure_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exposureTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
        <span class="n">aperture</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;aperture&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
        <span class="n">pixel_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pixelScale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
        <span class="n">numSpecWaveBins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;numSpecWaveBins&#39;</span><span class="p">]</span>
        
        <span class="n">flux_bkg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_bkg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">)</span>
        <span class="n">bkg_count_rates</span> <span class="o">=</span> <span class="n">_count_rate_numba</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">flux_bkg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">waves_at_pixel</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">throughput_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_constants</span><span class="p">,</span> <span class="n">numSpecWaveBins</span><span class="p">,</span>
            <span class="n">aperture</span><span class="p">,</span> <span class="n">pixel_scale</span>
        <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_perpendicular</span><span class="p">),</span> 
                            <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_parallel</span><span class="p">)):</span>
            
            <span class="n">n_exposure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_exposure_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            
            <span class="c1"># print(f&#39;{i}, {j}: {n_exposure}&#39;)</span>
            
            <span class="k">if</span> <span class="n">n_exposure</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">spectrum_counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">bkg_count_rates</span><span class="p">)</span>
                <span class="n">noise_counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">bkg_count_rates</span><span class="p">)</span>
                <span class="n">sed_counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">bkg_count_rates</span><span class="p">)</span>
                <span class="k">continue</span>
        
            <span class="n">spectrum_count_rates</span> <span class="o">=</span> <span class="n">_count_rate_numba</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">msa_array</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">waves_at_pixel</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">throughput_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_constants</span><span class="p">,</span> <span class="n">numSpecWaveBins</span><span class="p">,</span> 
                <span class="n">aperture</span><span class="p">,</span> <span class="n">pixel_scale</span>
            <span class="p">)</span>
            
            <span class="n">idx</span> <span class="o">=</span> <span class="n">spectrum_count_rates</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="n">spectrum_count_rates</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="n">sed_counts</span> <span class="o">=</span> <span class="n">spectrum_count_rates</span> <span class="o">*</span> <span class="n">n_exposure</span> <span class="o">*</span> <span class="n">exposure_time</span>
            
            <span class="n">dark_current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;darkCurrent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="o">**-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">read_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;readOut&#39;</span><span class="p">]</span>
            
            <span class="n">spectrum_counts</span><span class="p">,</span> <span class="n">noise_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_noise_static</span><span class="p">(</span>
                <span class="n">spectrum_count_rates</span><span class="p">,</span> <span class="n">bkg_count_rates</span><span class="p">,</span>
                <span class="n">n_exposure</span><span class="p">,</span> <span class="n">exposure_time</span><span class="p">,</span>
                <span class="n">dark_current</span><span class="p">,</span> <span class="n">read_out</span>
            <span class="p">)</span>
            
            <span class="n">spectrum_counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum_counts</span>
            <span class="n">noise_counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise_counts</span>
            <span class="n">sed_counts_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sed_counts</span>
        
        <span class="k">return</span> <span class="n">spectrum_counts_array</span><span class="p">,</span> <span class="n">noise_counts_array</span><span class="p">,</span> <span class="n">sed_counts_array</span>
    

    <span class="k">def</span><span class="w"> </span><span class="nf">_display_exposures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">displaySpectrumAtPixel</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        
        <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_exposure_output</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        
        <span class="n">norm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">viridis</span>
        
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
                <span class="n">n_exposure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_exposure_output</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
                <span class="n">facecolor</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">n_exposure</span><span class="p">))</span>
                
                <span class="n">rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
                    <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">height</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="n">facecolor</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
                
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
        
        <span class="n">sm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$n_{\rm exp}$&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">y_pix</span><span class="p">,</span> <span class="n">x_pix</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">displaySpectrumAtPixel</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">x_pix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">x_pix</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">y_pix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_pix</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">)])</span>
        
        <span class="n">y_tick_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="n">y</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">y_tick_indices</span><span class="p">])</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">)])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">y_tick_indices</span><span class="p">])</span>
        
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;MSA_exposures.png&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_display_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataTensor</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                         <span class="n">displaySpectrumAtPixel</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                         <span class="n">displayEmissionLines</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> 
                         <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        
        <span class="n">el_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">el_waves</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">displayEmissionLines</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">wave</span> <span class="o">=</span> <span class="n">get_wave_for_emission_line</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">wave</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;viewRedshift&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">wave</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_wave</span> <span class="ow">or</span> <span class="n">wave</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_wave</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Emission line </span><span class="si">{</span><span class="n">el</span><span class="si">}</span><span class="s1"> is out of the wavelength range.&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">el_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">el_waves</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span>
        
        <span class="n">num_spectra</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">displaySpectrumAtPixel</span><span class="p">)</span>
        
        <span class="n">unit_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;electron&#39;</span><span class="p">:</span> <span class="s1">&#39;electron&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;flux_lambda&#39;</span><span class="p">:</span> <span class="s1">&#39;erg / cm^2 / s / angstrom&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;flux_nu&#39;</span><span class="p">:</span> <span class="s1">&#39;Jy&#39;</span><span class="p">}</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">unit_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]]</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_spectra</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">num_spectra</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">displaySpectrumAtPixel</span><span class="p">):</span>
            
            <span class="n">y_pix</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x_pix</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">n_exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_exposure_output</span><span class="p">[</span><span class="n">y_pix</span><span class="p">,</span> <span class="n">x_pix</span><span class="p">]</span>
            
            <span class="n">wave</span> <span class="o">=</span> <span class="n">dataTensor</span><span class="p">[</span><span class="n">y_pix</span><span class="p">,</span> <span class="n">x_pix</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">wave_begin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span>
            <span class="n">wave_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span>
            
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">dataTensor</span><span class="p">[</span><span class="n">y_pix</span><span class="p">,</span> <span class="n">x_pix</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
                <span class="n">dataTensor</span><span class="p">[</span><span class="n">y_pix</span><span class="p">,</span> <span class="n">x_pix</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> 
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Spectrum&#39;</span>
                <span class="p">)</span>
            <span class="c1"># axs[i].plot(</span>
            <span class="c1">#     dataTensor[y_pix, x_pix, 0],</span>
            <span class="c1">#     dataTensor[y_pix, x_pix, 3],</span>
            <span class="c1">#     label=&#39;SED&#39;,</span>
            <span class="c1">#     linestyle=&#39;--&#39;</span>
            <span class="c1"># )</span>
            <span class="c1"># Plot error on a secondary y-axis on the right</span>
            <span class="n">ax_err</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">ax_err</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">dataTensor</span><span class="p">[</span><span class="n">y_pix</span><span class="p">,</span> <span class="n">x_pix</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">dataTensor</span><span class="p">[</span><span class="n">y_pix</span><span class="p">,</span> <span class="n">x_pix</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span>
            <span class="p">)</span>
            <span class="n">ax_err</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;Error [$</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s1">$]&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
            <span class="n">ax_err</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">)</span>
            
            <span class="n">y_min_spec</span><span class="p">,</span> <span class="n">y_max_spec</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
            <span class="n">y_min_err</span><span class="p">,</span> <span class="n">y_max_err</span> <span class="o">=</span> <span class="n">ax_err</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
            
            <span class="n">y_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_min_spec</span><span class="p">,</span> <span class="n">y_min_err</span><span class="p">)</span>
            <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_max_spec</span><span class="p">,</span> <span class="n">y_max_err</span><span class="p">)</span>
            
            <span class="n">y_pos</span> <span class="o">=</span> <span class="n">y_max</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">wave</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">el_names</span><span class="p">,</span> <span class="n">el_waves</span><span class="p">):</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">wave</span> <span class="o">+</span> <span class="mi">50</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> 
                            <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
            
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength [$\AA$]&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;flux [$</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s1">$]&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">wave_begin</span><span class="p">,</span> <span class="n">wave_end</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">t_exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exposureTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;Spectrum </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> at pixel (</span><span class="si">{</span><span class="n">y_pix</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">x_pix</span><span class="si">}</span><span class="s1">) ($t_</span><span class="se">{{</span><span class="s1">\rm exp</span><span class="se">}}</span><span class="s1">$ = $</span><span class="si">{</span><span class="n">n_exp</span><span class="si">}</span><span class="s1"> \times </span><span class="si">{</span><span class="n">t_exp</span><span class="si">}</span><span class="s1">$ min)&#39;</span><span class="p">)</span>
            <span class="c1"># axs[i].legend(frameon=False)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;MSA_spectra.png&#39;</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_display_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataTensor</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                             <span class="n">displaySpectrumAtPixel</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        
        <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">dataTensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dataTensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        
        <span class="c1"># total flux over all wavelengths</span>
        <span class="n">display_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">dataTensor</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">unit_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span>
        <span class="n">unit_comment_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;electron&#39;</span><span class="p">:</span> <span class="s1">&#39;electrons&#39;</span><span class="p">,</span>
            <span class="s1">&#39;flux_lambda&#39;</span><span class="p">:</span> <span class="s1">&#39;erg / cm^2 / s / angstrom&#39;</span><span class="p">,</span>
            <span class="s1">&#39;flux_nu&#39;</span><span class="p">:</span> <span class="s1">&#39;Jy&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="c1"># Calculate coverage in arcsec</span>
        <span class="n">y_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ditherSize&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span> <span class="o">*</span> <span class="n">ny</span>
        <span class="n">x_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;slitletSizeParallel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span> <span class="o">*</span> <span class="n">nx</span>
        
        <span class="n">x_tick_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">x_coverage</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">x_tick_max</span> <span class="o">=</span> <span class="n">x_coverage</span> <span class="o">/</span> <span class="mi">2</span>
        
        <span class="n">y_tick_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">y_coverage</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y_tick_max</span> <span class="o">=</span> <span class="n">y_coverage</span> <span class="o">/</span> <span class="mi">2</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">display_array</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray_r&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Accumulated flux over all wavelengths&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Flux [</span><span class="si">{</span><span class="n">unit_comment_dict</span><span class="p">[</span><span class="n">unit_type</span><span class="p">]</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
        
        <span class="c1"># Set ticks and labels in arcsec</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">11</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">11</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_tick_min</span><span class="p">,</span> <span class="n">x_tick_max</span><span class="p">,</span> <span class="mi">11</span><span class="p">)])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_tick_min</span><span class="p">,</span> <span class="n">y_tick_max</span><span class="p">,</span> <span class="mi">11</span><span class="p">)])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Parallel direction (arcsec)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Perpendicular direction (arcsec)&quot;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">y_pix</span><span class="p">,</span> <span class="n">x_pix</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">displaySpectrumAtPixel</span><span class="p">):</span>
            <span class="c1"># x = ((x_pix + 1) + x_pix) / 2</span>
            <span class="c1"># y = ((y_pix + 1) + y_pix) / 2</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_pix</span><span class="p">,</span> <span class="n">y_pix</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Spectrum </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">savefilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;MSA_observation.png&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefilename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_display_MSA_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataTensor</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                         <span class="n">cube_display</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                         <span class="n">slice_wavelength</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                         <span class="n">displaySpectrumAtPixel</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                         <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        
        <span class="n">y_center_tensor</span> <span class="o">=</span> <span class="n">dataTensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">x_center_tensor</span> <span class="o">=</span> <span class="n">dataTensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        
        <span class="n">y_deviations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x_deviations</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">displaySpectrumAtPixel</span><span class="p">):</span>
            
            <span class="n">y_pix</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x_pix</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">y_deviations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_pix</span> <span class="o">-</span> <span class="n">y_center_tensor</span><span class="p">)</span>
            <span class="n">x_deviations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_pix</span> <span class="o">-</span> <span class="n">x_center_tensor</span><span class="p">)</span>
            
        <span class="n">y_deviations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_deviations</span><span class="p">)</span>
        <span class="n">x_deviations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_deviations</span><span class="p">)</span>
        
        <span class="n">y_deviations</span> <span class="o">=</span> <span class="n">y_deviations</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ditherSize&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pixelScale&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
        <span class="n">x_deviations</span> <span class="o">=</span> <span class="n">x_deviations</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_slitlet_parallel</span>
        
        <span class="n">y_center_cube_slice</span> <span class="o">=</span> <span class="n">cube_display</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">x_center_cube_slice</span> <span class="o">=</span> <span class="n">cube_display</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        
        <span class="n">y_coordinates</span> <span class="o">=</span> <span class="n">y_center_cube_slice</span> <span class="o">+</span> <span class="n">y_deviations</span>
        <span class="n">x_coordinates</span> <span class="o">=</span> <span class="n">x_center_cube_slice</span> <span class="o">+</span> <span class="n">x_deviations</span>
        
        <span class="n">num_pixels</span> <span class="o">=</span> <span class="n">cube_display</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># rotate first and them shift</span>
        <span class="c1"># shift the plane instead of the slitlets</span>
        <span class="n">cube_display</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">cube_display</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">cube_display</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">newbyteorder</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)),</span>
                              <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;rotate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span> 
                              <span class="n">resize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">cube_display</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shift_image_static</span><span class="p">(</span>
            <span class="n">cube_display</span><span class="p">,</span> 
            <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_perpendicular</span><span class="p">,</span>
            <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_parallel</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;viewRedshift&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;viewRedshift&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="s1">&#39;0.00&#39;</span>
            
        <span class="k">if</span> <span class="s1">&#39;stellarMass&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;stellarMass&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logM</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;stellarMass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logM</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
        <span class="n">pixelscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pixelScale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="c1"># the physical resol should also be added</span>

        <span class="n">scalebarSize</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">num_pixels</span> <span class="o">*</span> <span class="n">resolution</span>
        <span class="k">if</span> <span class="n">scalebarSize</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">scalebarUnit</span> <span class="o">=</span> <span class="s1">&#39;kpc&#39;</span>
            <span class="n">scalebarSize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">scalebarSize</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">resolution</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scalebarUnit</span> <span class="o">=</span> <span class="s1">&#39;pc&#39;</span>
            <span class="n">scalebarSize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">scalebarSize</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">resolution</span>
            
        <span class="n">pc_dim</span> <span class="o">=</span> <span class="n">ParsecDimension</span><span class="p">()</span>
        <span class="n">scalebar</span> <span class="o">=</span> <span class="n">ScaleBar</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">scalebarUnit</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">pc_dim</span><span class="p">,</span> 
                            <span class="n">fixed_value</span><span class="o">=</span><span class="n">scalebarSize</span><span class="p">,</span> <span class="n">fixed_units</span><span class="o">=</span><span class="n">scalebarUnit</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">location</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">scale_loc</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">font_properties</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arcsinh</span><span class="p">(</span><span class="n">cube_display</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray_r&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
        <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Asinh(Flux) [MJy/sr]&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">y_coord</span><span class="p">,</span> <span class="n">x_coord</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">y_coordinates</span><span class="p">,</span> <span class="n">x_coordinates</span><span class="p">)):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_coord</span><span class="p">,</span> <span class="n">y_coord</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Spectrum </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

        <span class="n">tick_min</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;displayBoxSize&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">tick_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;displayBoxSize&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">cube_display</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">11</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">cube_display</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">11</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tick_min</span><span class="p">,</span> <span class="n">tick_max</span><span class="p">,</span> <span class="mi">11</span><span class="p">)])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tick_min</span><span class="p">,</span> <span class="n">tick_max</span><span class="p">,</span> <span class="mi">11</span><span class="p">)])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Parallel direction (arcsec)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Perpendicular direction (arcsec)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cube_display</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cube_display</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">scalebar</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;Data cube slice at $\lambda$ = </span><span class="si">{</span><span class="n">slice_wavelength</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> $\AA$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;$</span><span class="se">{{</span><span class="s1">\rm log</span><span class="se">}}</span><span class="s1">M_</span><span class="se">{{</span><span class="s1">\star</span><span class="se">}}</span><span class="s1"> = </span><span class="si">{</span><span class="n">logM</span><span class="si">}</span><span class="s1">$&#39;</span><span class="p">,</span>
                            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;$z$ = </span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ID:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;subhaloID&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

        <span class="n">cube_slice</span> <span class="o">=</span> <span class="n">cube_display</span>

        <span class="n">arrow_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.15</span>  <span class="c1"># 15% of image size</span>
        <span class="n">arrow_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">))</span>  <span class="c1"># minimum width is 1</span>
        <span class="n">perp_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">)</span>  <span class="c1"># 30% of image height</span>
        <span class="n">para_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">)</span>  <span class="c1"># 30% of image width</span>
        <span class="c1"># Position arrows in upper left corner (in data coordinates)</span>
        <span class="n">arrow_x_start</span> <span class="o">=</span> <span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.05</span>
        <span class="n">arrow_y_start</span> <span class="o">=</span> <span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.9</span>

        <span class="c1"># Perpendicular arrow (vertical, pointing up)</span>
        <span class="n">perp_arrow</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">FancyArrowPatch</span><span class="p">(</span>
            <span class="p">(</span><span class="n">arrow_x_start</span><span class="p">,</span> <span class="n">arrow_y_start</span><span class="p">),</span>
            <span class="p">(</span><span class="n">arrow_x_start</span><span class="p">,</span> <span class="n">arrow_y_start</span> <span class="o">-</span> <span class="n">perp_length</span><span class="p">),</span>
            <span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;&lt;-&gt;&#39;</span><span class="p">,</span> 
            <span class="n">mutation_scale</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="n">arrow_width</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">perp_arrow</span><span class="p">)</span>

        <span class="c1"># Parallel arrow (horizontal, pointing right)</span>
        <span class="n">para_arrow</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">FancyArrowPatch</span><span class="p">(</span>
            <span class="p">(</span><span class="n">arrow_x_start</span><span class="p">,</span> <span class="n">arrow_y_start</span><span class="p">),</span>
            <span class="p">(</span><span class="n">arrow_x_start</span> <span class="o">+</span> <span class="n">para_length</span><span class="p">,</span> <span class="n">arrow_y_start</span><span class="p">),</span>
            <span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;&lt;-&gt;&#39;</span><span class="p">,</span>
            <span class="n">mutation_scale</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="n">arrow_width</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">para_arrow</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">arrow_x_start</span> <span class="o">-</span> <span class="n">arrow_length</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">arrow_y_start</span> <span class="o">-</span> <span class="n">perp_length</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s1">&#39;Perpendicular&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> 
                <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">rotation_mode</span><span class="o">=</span><span class="s1">&#39;anchor&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">arrow_x_start</span> <span class="o">+</span> <span class="n">para_length</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">arrow_y_start</span> <span class="o">+</span> <span class="n">para_length</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s1">&#39;Parallel&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> 
                <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rotation_mode</span><span class="o">=</span><span class="s1">&#39;anchor&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

        <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;slitletSizeParallel&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pixelScale&#39;</span><span class="p">])</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;slitletSizePerpendicular&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pixelScale&#39;</span><span class="p">])</span>
        
        <span class="n">all_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size_parallel</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pixelScale&#39;</span><span class="p">])</span>
        <span class="n">all_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size_perpendicular</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pixelScale&#39;</span><span class="p">])</span>

        <span class="n">center_x</span> <span class="o">=</span> <span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">center_y</span> <span class="o">=</span> <span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="c1"># Translation offsets</span>
        <span class="n">offset_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_parallel</span>  <span class="c1"># pixels to move right (negative for left)</span>
        <span class="n">offset_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_perpendicular</span>  <span class="c1"># pixels to move down (negative for up)</span>

        <span class="c1"># Apply translation to center</span>
        <span class="n">translated_center_x</span> <span class="o">=</span> <span class="n">center_x</span> <span class="o">+</span> <span class="n">offset_x</span>
        <span class="n">translated_center_y</span> <span class="o">=</span> <span class="n">center_y</span> <span class="o">+</span> <span class="n">offset_y</span>

        <span class="c1"># Number of rectangles above and below center</span>

        <span class="n">n_upper</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nSlitlets&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">n_lower</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nSlitlets&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nSlitlets&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># 0, 1, 2, 3, 4, 5 (6 sitlets) -&gt; center at 2, n_lower = 2, n_upper = 3</span>
            <span class="n">n_upper</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Gap between rectangles (in pixels)</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Rotation angle in degrees</span>
        <span class="n">rotation_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;rotate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>

        <span class="c1"># Create all rectangles using translated center</span>
        <span class="n">rectangles</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># observable area</span>
        <span class="c1"># obs_rect = patches.Rectangle(</span>
        <span class="c1">#     (translated_center_x - all_width / 2, translated_center_y - all_height / 2),</span>
        <span class="c1">#     all_width,</span>
        <span class="c1">#     all_height,</span>
        <span class="c1">#     edgecolor=&#39;green&#39;,</span>
        <span class="c1">#     facecolor=&#39;none&#39;,</span>
        <span class="c1"># )</span>
        <span class="c1"># rectangles.append(obs_rect)</span>

        <span class="c1"># Center rectangle</span>
        <span class="n">center_rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
            <span class="p">(</span><span class="n">translated_center_x</span> <span class="o">-</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">translated_center_y</span> <span class="o">-</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">width</span><span class="p">,</span> 
            <span class="n">height</span><span class="p">,</span> 
            <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">rectangles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">center_rect</span><span class="p">)</span>

        <span class="c1"># Create upper rectangles</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_upper</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">upper_rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
            <span class="p">(</span><span class="n">translated_center_x</span> <span class="o">-</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">translated_center_y</span> <span class="o">-</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span> <span class="o">+</span> <span class="n">gap</span><span class="p">)),</span>
            <span class="n">width</span><span class="p">,</span>
            <span class="n">height</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rectangles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upper_rect</span><span class="p">)</span>

        <span class="c1"># Create lower rectangles</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_lower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">lower_rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
            <span class="p">(</span><span class="n">translated_center_x</span> <span class="o">-</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">translated_center_y</span> <span class="o">+</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span> <span class="o">+</span> <span class="n">gap</span><span class="p">)</span> <span class="o">+</span> <span class="n">gap</span><span class="p">),</span>
            <span class="n">width</span><span class="p">,</span>
            <span class="n">height</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rectangles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lower_rect</span><span class="p">)</span>

        <span class="c1"># Apply rotation transform around the translated center point</span>
        <span class="c1"># transform = Affine2D().rotate_deg_around(</span>
        <span class="c1">#     translated_center_x, translated_center_y, rotation_angle</span>
        <span class="c1"># ) + ax.transData</span>

        <span class="c1"># Add all rectangles with the rotation transform</span>
        <span class="k">for</span> <span class="n">rect</span> <span class="ow">in</span> <span class="n">rectangles</span><span class="p">:</span>
            <span class="c1"># rect.set_transform(transform)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
                
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;MSA_slitlets.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_shift_image_static</span><span class="p">(</span><span class="n">cube_slice</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">dy</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        
        <span class="c1"># 2d image shift</span>
        
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cube_slice</span><span class="p">)</span> <span class="c1"># 2d array</span>
        
        <span class="n">y1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">h</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">w</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
        
        <span class="n">result</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cube_slice</span><span class="p">[</span><span class="n">y1</span> <span class="o">-</span> <span class="n">dy</span><span class="p">:</span><span class="n">y2</span> <span class="o">-</span> <span class="n">dy</span><span class="p">,</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">dx</span><span class="p">:</span><span class="n">x2</span> <span class="o">-</span> <span class="n">dx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_downsample_static</span><span class="p">(</span><span class="n">cube_slice</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">oversample</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">down_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">oversample</span><span class="p">,</span> <span class="n">oversample</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">down_factor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">oversample</span><span class="p">,</span> <span class="n">oversample</span><span class="p">)</span>
            
        <span class="n">cube_slice</span> <span class="o">=</span> <span class="n">downscale_local_mean</span><span class="p">(</span><span class="n">cube_slice</span><span class="p">,</span> <span class="n">down_factor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cube_slice</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_padding_cube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        
        <span class="k">if</span> <span class="n">cube</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_shape</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;size must have the same length as cube.shape&quot;</span><span class="p">)</span>
        
        <span class="n">padding_size</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">target_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">padding_size</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">target_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                
                    <span class="n">padding_needed</span> <span class="o">=</span> <span class="n">target_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">before_padding_size</span> <span class="o">=</span> <span class="n">padding_needed</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="n">after_padding_size</span> <span class="o">=</span> <span class="n">padding_needed</span> <span class="o">-</span> <span class="n">before_padding_size</span>
                
                <span class="k">else</span><span class="p">:</span>
                    
                    <span class="n">before_padding_size</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">after_padding_size</span> <span class="o">=</span> <span class="mi">0</span>
                    
                <span class="n">padding_size</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">before_padding_size</span><span class="p">,</span> <span class="n">after_padding_size</span><span class="p">))</span>
        
        <span class="n">padding_size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">padding_size</span><span class="p">)</span>
        <span class="n">padded_cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">padding_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">padded_cube</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_padding_static</span><span class="p">(</span><span class="n">cube_slice</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        
        <span class="k">if</span> <span class="n">cube_slice</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_shape</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;size must have the same length as cube_slice.shape&quot;</span><span class="p">)</span>
        
        <span class="n">padding_size</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">target_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">padding_needed</span> <span class="o">=</span> <span class="n">target_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">before_padding_size</span> <span class="o">=</span> <span class="n">padding_needed</span> <span class="o">//</span> <span class="mi">2</span>
                <span class="n">after_padding_size</span> <span class="o">=</span> <span class="n">padding_needed</span> <span class="o">-</span> <span class="n">before_padding_size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">before_padding_size</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">after_padding_size</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="n">padding_size</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">before_padding_size</span><span class="p">,</span> <span class="n">after_padding_size</span><span class="p">))</span>
        
        <span class="n">padding_size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">padding_size</span><span class="p">)</span>
        <span class="n">padded_cube_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
            <span class="n">cube_slice</span><span class="p">,</span> <span class="n">padding_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">padded_cube_slice</span>
    
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_standardize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube_slice</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">target_size</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        
        
        <span class="n">padded_cube_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_padding_static</span><span class="p">(</span><span class="n">cube_slice</span><span class="p">,</span> <span class="n">target_size</span><span class="p">)</span>
        <span class="n">cropped_cube_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center_crop</span><span class="p">(</span>
            <span class="n">padded_cube_slice</span><span class="p">,</span> <span class="n">target_size</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">cropped_cube_slice</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_center_crop</span><span class="p">(</span><span class="n">cube_slice</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        
        <span class="k">if</span> <span class="n">cube_slice</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_shape</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;target_shape must have the same length as arr.ndim&quot;</span><span class="p">)</span>

        <span class="n">slices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cube_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="o">&lt;=</span> <span class="n">target</span><span class="p">:</span>
                <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">target</span>
                <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cube_slice</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">slices</span><span class="p">)]</span>
    
<div class="viewcode-block" id="PostProcess.input_particle_file">
<a class="viewcode-back" href="../../api.html#galaxyGeniusMSA.postprocess.PostProcess.input_particle_file">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">input_particle_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particle_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the filename for the input particle file. This method updates the instance so that</span>
<span class="sd">        future operations use the provided particle file instead of a default path. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        particle_file : str</span>
<span class="sd">            Path to the particle file to use as input for this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">input_particle_file_called</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_file</span> <span class="o">=</span> <span class="n">particle_file</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_save_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">properties_array</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                         <span class="n">properties_units</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        
        <span class="n">n_pixel_perpendicular</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_perpendicular</span>
        <span class="n">n_pixel_parallel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_output_parallel</span>
        
        <span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">()</span>
        <span class="n">primary_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">()</span>
        <span class="n">hdulist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">primary_hdu</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">prop</span><span class="p">,</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">properties_array</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            
            <span class="c1"># only save central part </span>
            
            <span class="n">y_center_array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">x_center_array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
            
            <span class="c1"># For extracting n elements centered around center:</span>
            <span class="c1"># Start: center - n//2, End: center + (n+1)//2</span>
            <span class="c1"># This works correctly for both odd and even n</span>
            <span class="n">perpendicular_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span>
                <span class="n">y_center_array</span> <span class="o">-</span> <span class="n">n_pixel_perpendicular</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">y_center_array</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_pixel_perpendicular</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="p">)</span>
            
            <span class="n">parallel_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span>
                <span class="n">x_center_array</span> <span class="o">-</span> <span class="n">n_pixel_parallel</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">x_center_array</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_pixel_parallel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="p">)</span>
            
            <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">perpendicular_slice</span><span class="p">,</span> <span class="n">parallel_slice</span><span class="p">]</span>
            
            <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="c1"># Add property name and unit to header</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PROP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">properties_units</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;UNIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit</span>
            <span class="n">hdulist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>
        
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;True_properties.fits&#39;</span><span class="p">)</span>
        <span class="n">hdulist</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_display_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">properties_array</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                            <span class="n">properties_units</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">properties_array</span><span class="p">),</span>
                               <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">properties_array</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">properties_array</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">properties_array</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">properties_units</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span>
            
            <span class="n">y_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ditherSize&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span> <span class="o">*</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;slitletSizeParallel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span> <span class="o">*</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">x_tick_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">x_coverage</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">x_tick_max</span> <span class="o">=</span> <span class="n">x_coverage</span> <span class="o">/</span> <span class="mi">2</span>
            
            <span class="n">y_tick_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">y_coverage</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">y_tick_max</span> <span class="o">=</span> <span class="n">y_coverage</span> <span class="o">/</span> <span class="mi">2</span>
            
            <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
            <span class="k">elif</span> <span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;solMass&#39;</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;Msun&#39;</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                         <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray_r&#39;</span><span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">11</span><span class="p">))</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">11</span><span class="p">))</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_tick_min</span><span class="p">,</span> <span class="n">x_tick_max</span><span class="p">,</span> <span class="mi">11</span><span class="p">)])</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_tick_min</span><span class="p">,</span> <span class="n">y_tick_max</span><span class="p">,</span> <span class="mi">11</span><span class="p">)])</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Parallel direction (arcsec)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Perpendicular direction (arcsec)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># Draw rectangle with specified size in arcsec</span>
            <span class="c1"># Rectangle bounds in arcsec</span>
            <span class="n">rect_x_min_arcsec</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">size_parallel</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">rect_x_max_arcsec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_parallel</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">rect_y_min_arcsec</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">size_perpendicular</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">rect_y_max_arcsec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_perpendicular</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            
            <span class="c1"># Convert arcsec to pixel coordinates</span>
            <span class="n">x_pixel_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">rect_x_min_arcsec</span> <span class="o">-</span> <span class="n">x_tick_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_tick_max</span> <span class="o">-</span> <span class="n">x_tick_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">x_pixel_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">rect_x_max_arcsec</span> <span class="o">-</span> <span class="n">x_tick_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_tick_max</span> <span class="o">-</span> <span class="n">x_tick_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">y_pixel_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">rect_y_min_arcsec</span> <span class="o">-</span> <span class="n">y_tick_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">y_tick_max</span> <span class="o">-</span> <span class="n">y_tick_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">y_pixel_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">rect_y_max_arcsec</span> <span class="o">-</span> <span class="n">y_tick_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">y_tick_max</span> <span class="o">-</span> <span class="n">y_tick_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># Create rectangle patch</span>
            <span class="n">rect_width</span> <span class="o">=</span> <span class="n">x_pixel_max</span> <span class="o">-</span> <span class="n">x_pixel_min</span>
            <span class="n">rect_height</span> <span class="o">=</span> <span class="n">y_pixel_max</span> <span class="o">-</span> <span class="n">y_pixel_min</span>
            <span class="n">rectangle</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                <span class="p">(</span><span class="n">x_pixel_min</span><span class="p">,</span> <span class="n">y_pixel_min</span><span class="p">),</span>
                <span class="n">rect_width</span><span class="p">,</span>
                <span class="n">rect_height</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rectangle</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">savefilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;True_properties.png&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefilename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">functions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">callable</span><span class="p">]]</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]):</span>
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;input_particle_file_called&#39;</span><span class="p">)</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_particle_file_called</span> \
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_file</span><span class="p">):</span>
            <span class="n">particle_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Use input particle file: </span><span class="si">{</span><span class="n">particle_file</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">particle_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataCubeDir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Subhalo_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subhaloID</span><span class="si">}</span><span class="s1">_particles.h5&#39;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Use particle file saved in preprocessing: </span><span class="si">{</span><span class="n">particle_file</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">particle_file</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Particle file not found: </span><span class="si">{</span><span class="n">particle_file</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Particle file not found: </span><span class="si">{</span><span class="n">particle_file</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            
        <span class="n">inclination</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viewing_angle</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">azimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viewing_angle</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">phyRes_perpendicular</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;lumiDis&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ditherSize&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
        <span class="n">phyRes_perpendicular</span> <span class="o">=</span> <span class="n">phyRes_perpendicular</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kpc</span><span class="p">)</span>
        
        <span class="n">phyRes_parallel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;lumiDis&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;slitletSizeParallel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
        <span class="n">phyRes_parallel</span> <span class="o">=</span> <span class="n">phyRes_parallel</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kpc</span><span class="p">)</span>
        
        <span class="n">n_pixels_perpendicular_display</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;displayBoxSize&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ditherSize&#39;</span><span class="p">])</span>
        
        <span class="n">bins_perpendicular</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">phyRes_perpendicular</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_pixels_perpendicular_display</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
                                         <span class="n">phyRes_perpendicular</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_pixels_perpendicular_display</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> 
                                         <span class="n">n_pixels_perpendicular_display</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">n_pixels_parallel_display</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;displayBoxSize&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;slitletSizeParallel&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">n_pixels_parallel_display</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bins_parallel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">phyRes_parallel</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_pixels_parallel_display</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
                                        <span class="n">phyRes_parallel</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_pixels_parallel_display</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> 
                                        <span class="n">n_pixels_parallel_display</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">half</span> <span class="o">=</span> <span class="n">phyRes_parallel</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">bins_parallel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">phyRes_parallel</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_pixels_parallel_display</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">half</span><span class="p">,</span> 
                                        <span class="n">phyRes_parallel</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_pixels_parallel_display</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">half</span><span class="p">,</span>
                                        <span class="n">n_pixels_parallel_display</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># for debug</span>
        <span class="c1"># bins_perpendicular = np.linspace(-40, 40, 100) # kpc</span>
        <span class="c1"># bins_parallel = np.linspace(-40, 40, 100) # kpc</span>
        
        <span class="c1"># in kpc</span>
        <span class="n">shift_perpendicular</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;lumiDis&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;offsetPerpendicular&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
        <span class="n">shift_perpendicular</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">shift_perpendicular</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kpc</span><span class="p">))</span>
        <span class="n">shift_parallel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;lumiDis&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;offsetParallel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
        <span class="n">shift_parallel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">shift_parallel</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kpc</span><span class="p">))</span>
        
        <span class="n">rotate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;rotate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
        
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;particle_file&#39;</span><span class="p">:</span> <span class="n">particle_file</span><span class="p">,</span>
            <span class="s1">&#39;inclination&#39;</span><span class="p">:</span> <span class="n">inclination</span><span class="p">,</span>
            <span class="s1">&#39;azimuth&#39;</span><span class="p">:</span> <span class="n">azimuth</span><span class="p">,</span>
            <span class="s1">&#39;bins_perpendicular&#39;</span><span class="p">:</span> <span class="n">bins_perpendicular</span><span class="p">,</span>
            <span class="s1">&#39;bins_parallel&#39;</span><span class="p">:</span> <span class="n">bins_parallel</span><span class="p">,</span>
            <span class="s1">&#39;transformation&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;rotate&#39;</span><span class="p">:</span> <span class="n">rotate</span><span class="p">,</span> 
                               <span class="s1">&#39;shiftParallel&#39;</span><span class="p">:</span> <span class="n">shift_parallel</span><span class="p">,</span>
                               <span class="s1">&#39;shiftPerpendicular&#39;</span><span class="p">:</span> <span class="n">shift_perpendicular</span><span class="p">},</span>
            <span class="s1">&#39;subhalo_info&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subhalo_info</span><span class="p">,</span>
            <span class="s1">&#39;configs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="n">properties_array</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">properties_units</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">properties</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">functions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">stats</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
                <span class="n">properties_array</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span>
                <span class="n">properties_units</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error calculating property </span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
        
        <span class="k">return</span> <span class="n">properties_array</span><span class="p">,</span> <span class="n">properties_units</span>
        
<div class="viewcode-block" id="PostProcess.create_MSA_dataTensor">
<a class="viewcode-back" href="../../api.html#galaxyGeniusMSA.postprocess.PostProcess.create_MSA_dataTensor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_MSA_dataTensor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the data tensor for the MSA simulation, including signal, noise, and sed arrays.</span>

<span class="sd">        This method orchestrates the full creation process for the MSA (Multi-Shutter Array) data tensor.</span>
<span class="sd">        It performs the following major steps:</span>

<span class="sd">        - Define the wavelength sampling based on instrument resolution</span>
<span class="sd">        - Retrieve or generate the relevant PSF cube</span>
<span class="sd">        - Simulate detector sampling over the spatial and spectral grids</span>
<span class="sd">        - Compute signal, noise, and sed arrays for each slitlet</span>
<span class="sd">        - Assemble all outputs into a single, well-formatted data tensor (4 dimensions)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataTensor : np.ndarray</span>
<span class="sd">            The full (n_slitlet_y, n_slitlet_x, 4, n_bins) array, ready for export or further use.</span>
<span class="sd">            </span>
<span class="sd">            Array structure:</span>
<span class="sd">            </span>
<span class="sd">            - data[...,0,:] = wavelengths (middle points)</span>
<span class="sd">            - data[...,1,:] = signal (flux or electron counts)</span>
<span class="sd">            - data[...,2,:] = noise (flux or electron counts)</span>
<span class="sd">            - data[...,3,:] = sed (flux or electron counts)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;MSA-3D simulation starts...&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_waves_by_resolution</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_waves_at_pixel</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Step 1: Processing spatial dimension (PSF convolution and transformation)&#39;</span><span class="p">)</span>
        
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting PSF cubes...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_PSF_cube</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PSF cube shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">psf_cube</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data cube shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataCube</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="n">msa_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_spatial_dimension</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MSA cube shape after spatial processing: </span><span class="si">{</span><span class="n">msa_array</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time taken for step 1: </span><span class="si">{</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Step 2: Processing spectral dimension (Simulation of spectra)&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting JWST background...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_bkg</span><span class="p">()</span>
        
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="n">spectrum_counts_array</span><span class="p">,</span> <span class="n">noise_counts_array</span><span class="p">,</span> <span class="n">sed_counts_array</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_spectral_dimension</span><span class="p">(</span><span class="n">msa_array</span><span class="p">)</span>
        
        <span class="c1"># input: 40, 18, num_wave, output: 40, 9, num_wave</span>
        <span class="n">spectrum_counts_array</span><span class="p">,</span> <span class="n">noise_counts_array</span><span class="p">,</span> <span class="n">sed_counts_array</span> <span class="o">=</span> <span class="n">_overlap_counts_numba</span><span class="p">(</span>
            <span class="n">spectrum_counts_array</span><span class="p">,</span> <span class="n">noise_counts_array</span><span class="p">,</span> <span class="n">sed_counts_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pixels_slitlet_parallel</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;electron&#39;</span><span class="p">:</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Convert unit to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
            
            <span class="n">signal_array</span><span class="p">,</span> <span class="n">noise_array</span><span class="p">,</span> <span class="n">sed_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_flux_array</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">waves_at_pixel</span><span class="p">,</span> <span class="n">spectrum_counts_array</span><span class="p">,</span> <span class="n">noise_counts_array</span><span class="p">,</span> <span class="n">sed_counts_array</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal_array</span> <span class="o">=</span> <span class="n">spectrum_counts_array</span>
            <span class="n">noise_array</span> <span class="o">=</span> <span class="n">noise_counts_array</span>
            <span class="n">sed_array</span> <span class="o">=</span> <span class="n">sed_counts_array</span>
        
        <span class="c1"># 40, 9, num_wave</span>
        <span class="n">signal_array</span><span class="p">,</span> <span class="n">noise_array</span><span class="p">,</span> <span class="n">sed_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rebin_fluxes_and_noise_array</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">waves_at_pixel</span><span class="p">,</span> <span class="n">signal_array</span><span class="p">,</span> <span class="n">noise_array</span><span class="p">,</span> <span class="n">sed_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">waves_by_resolution</span>
        <span class="p">)</span>
        
        <span class="n">dataTensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">waves_by_resolution</span><span class="p">,</span> <span class="n">signal_array</span><span class="p">,</span> <span class="n">noise_array</span><span class="p">,</span> <span class="n">sed_array</span>
        <span class="p">)</span>
        
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time taken for step 2: </span><span class="si">{</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> seconds&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MSA-3D simulation completed. Output shape: </span><span class="si">{</span><span class="n">dataTensor</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="n">savefilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;MSA_dataTensor.fits&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving data tensor to </span><span class="si">{</span><span class="n">savefilename</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_dataTensor</span><span class="p">(</span><span class="n">dataTensor</span><span class="p">,</span> <span class="n">savefilename</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="PostProcess.illustrate_MSA">
<a class="viewcode-back" href="../../api.html#galaxyGeniusMSA.postprocess.PostProcess.illustrate_MSA">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">illustrate_MSA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataTensor_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Illustrate the MSA (Micro-Shutter Array) data.</span>

<span class="sd">        This method generates a series of visualizations to illustrate the simulated MSA data,</span>
<span class="sd">        including exposure maps, spectral properties, emission line maps, and observed mosaics.</span>
<span class="sd">        The method can take an optional path to a data tensor FITS file; if none is provided, it</span>
<span class="sd">        loads the default output in the save path.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dataTensor_path : str or None, optional</span>
<span class="sd">            The path to the data tensor FITS file. If None, uses default output location.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Illustrating MSA...&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">dataTensor_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dataTensor_filename</span> <span class="o">=</span> <span class="n">dataTensor_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataTensor_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;MSA_dataTensor.fits&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dataTensor_filename</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data Tensor file </span><span class="si">{</span><span class="n">dataTensor_filename</span><span class="si">}</span><span class="s1"> does not exist.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dataTensor_filename</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">dataTensor</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        
        <span class="n">emission_line</span><span class="p">,</span> <span class="n">wave</span> <span class="o">=</span> <span class="n">get_wave_for_emission_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;displayAround&#39;</span><span class="p">])</span>
        <span class="n">target_wave</span> <span class="o">=</span> <span class="n">wave</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;viewRedshift&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">target_wave</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_wave</span> <span class="ow">or</span> <span class="n">target_wave</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_wave</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">emission_line</span><span class="si">}{</span><span class="n">wave</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> is out of range for begin_wave </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">begin_wave</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> and end_wave </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">end_wave</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Falling back to Ha6563&#39;</span><span class="p">)</span>
            
            <span class="n">emission_line</span> <span class="o">=</span> <span class="s1">&#39;Ha&#39;</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="mi">6563</span>
            <span class="n">target_wave</span> <span class="o">=</span> <span class="n">wave</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;viewRedshift&#39;</span><span class="p">])</span>
        
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span> <span class="o">-</span> <span class="n">target_wave</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">slice_wavelength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        
        <span class="n">extend</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="c1"># for situation when the line is at edges</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">50</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">50</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">):</span>
            <span class="n">extend</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">)</span> <span class="o">-</span> <span class="n">idx</span><span class="p">)</span>
        
        <span class="c1"># increase the signal by summing over the surrounding wavelengths</span>
        <span class="n">cube_display</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataCube</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="n">extend</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">extend</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cube_display</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_downsample_static</span><span class="p">(</span><span class="n">cube_display</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;oversample&#39;</span><span class="p">])</span>
        <span class="n">cube_display</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_standardize</span><span class="p">(</span>
            <span class="n">cube_display</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boxlength_in_pixel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxlength_in_pixel</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">displaySpectrumAtPixel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;displaySpectrumAtPixel&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_exposures</span><span class="p">(</span><span class="n">displaySpectrumAtPixel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">)</span>
        <span class="n">displayEmissionLines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;displayEmissionLines&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_spectra</span><span class="p">(</span><span class="n">dataTensor</span><span class="p">,</span> <span class="n">displaySpectrumAtPixel</span><span class="p">,</span> 
                              <span class="n">displayEmissionLines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_MSA_obs</span><span class="p">(</span>
            <span class="n">dataTensor</span><span class="p">,</span> <span class="n">cube_display</span><span class="p">,</span> <span class="n">slice_wavelength</span><span class="p">,</span> 
            <span class="n">displaySpectrumAtPixel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_observation</span><span class="p">(</span><span class="n">dataTensor</span><span class="p">,</span> <span class="n">displaySpectrumAtPixel</span><span class="p">,</span> 
                                  <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="PostProcess.get_truth_properties">
<a class="viewcode-back" href="../../api.html#galaxyGeniusMSA.postprocess.PostProcess.get_truth_properties">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_truth_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_defaults</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                             <span class="n">functions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">callable</span><span class="p">]]</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve, calculate and save ground-truth properties for the simulation.</span>

<span class="sd">        This method computes and saves various &quot;truth&quot; propertiessuch as metallicity, velocities,</span>
<span class="sd">        or mass mapsusing supplied property-function pairs (or the defaults). It can be extended to</span>
<span class="sd">        include custom properties and functions by the user.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        keep_defaults : bool, optional</span>
<span class="sd">            If True, include the default set of properties and functions in addition to any provided ones.</span>
<span class="sd">            If False, only use the user-supplied properties/functions. Default is True.</span>
<span class="sd">        properties : list of str, optional</span>
<span class="sd">            A list of property names to compute (each must have an associated callable).</span>
<span class="sd">        functions : list of callables or None, optional</span>
<span class="sd">            A list of functions to compute the corresponding properties. Each function should accept the required</span>
<span class="sd">            arguments to compute the property for the dataset. Defaults to [None], falling back to defaults.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting truth properties...&#39;</span><span class="p">)</span>
        
        <span class="c1"># default_properties = [&quot;Metallicity&quot;, &quot;RotationalVelocity&quot;,</span>
        <span class="c1">#                     &quot;LOSVelocity&quot;, &quot;Mass&quot;, &quot;VelDisp&quot;]</span>
        <span class="c1"># default_functions = [PostProcess.get_metallicity, PostProcess.get_rotational_velocity, </span>
        <span class="c1">#              PostProcess.get_los_velocity, PostProcess.get_velocity_dispersion, </span>
        <span class="c1">#              PostProcess.get_mass]</span>
        
        <span class="k">if</span> <span class="n">keep_defaults</span><span class="p">:</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Calculating default properties...&#39;</span><span class="p">)</span>
            
            <span class="n">default_properties</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MetallicityStarFormingRegion&#39;</span><span class="p">,</span> <span class="s1">&#39;MetallicityGas&#39;</span><span class="p">,</span> <span class="s1">&#39;LOSVelocity&#39;</span><span class="p">,</span> 
                                  <span class="s1">&#39;Mass&#39;</span><span class="p">,</span> <span class="s1">&#39;VelDisp&#39;</span><span class="p">,</span> <span class="s1">&#39;NumberStarformingRegion&#39;</span><span class="p">]</span>
            <span class="n">default_functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">property_metallicity_for_starforming_region</span><span class="p">,</span> 
                                <span class="n">property_gas_metallicity</span><span class="p">,</span> <span class="n">property_los_velocity</span><span class="p">,</span> 
                                <span class="n">property_total_stellar_mass</span><span class="p">,</span> <span class="n">property_velocity_dispersion</span><span class="p">,</span> 
                                <span class="n">property_number_starforming_region</span><span class="p">]</span>
            
            <span class="n">prop_to_func</span> <span class="o">=</span> <span class="p">{</span><span class="n">prop</span><span class="p">:</span> <span class="n">func</span> <span class="k">for</span> <span class="n">prop</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> 
                            <span class="nb">zip</span><span class="p">(</span><span class="n">default_properties</span><span class="p">,</span> <span class="n">default_functions</span><span class="p">)}</span>
            
            <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">functions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">functions</span><span class="p">),</span> \
                    <span class="s2">&quot;Number of properties and functions must be the same.&quot;</span>
                
                <span class="n">prop_to_func</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">prop</span><span class="p">:</span> <span class="n">func</span> <span class="k">for</span> <span class="n">prop</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> 
                                    <span class="nb">zip</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="n">functions</span><span class="p">)})</span>
            
        <span class="k">else</span><span class="p">:</span>
            
            <span class="n">prop_to_func</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="k">if</span> <span class="n">properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">functions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">functions</span><span class="p">),</span> \
                    <span class="s2">&quot;Number of properties and functions must be the same.&quot;</span>
                <span class="n">prop_to_func</span> <span class="o">=</span> <span class="p">{</span><span class="n">prop</span><span class="p">:</span> <span class="n">func</span> <span class="k">for</span> <span class="n">prop</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> 
                                <span class="nb">zip</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="n">functions</span><span class="p">)}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prop_to_func</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No properties and functions provided, skip true property calculation.&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Record properties: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">prop_to_func</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="n">properties</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prop_to_func</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">prop_to_func</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">]</span>
            
            <span class="n">properties_array</span><span class="p">,</span> <span class="n">properties_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_properties</span><span class="p">(</span>
                <span class="n">properties</span><span class="p">,</span> <span class="n">functions</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_properties</span><span class="p">(</span><span class="n">properties_array</span><span class="p">,</span> <span class="n">properties_units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_display_properties</span><span class="p">(</span><span class="n">properties_array</span><span class="p">,</span> <span class="n">properties_units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>